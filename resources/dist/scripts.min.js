function WebWorkerFactory(){var e=this;this.makeWorkerUsingScriptAtURL=function(t,n,i){e.getContentsOfFileAtURL(t,function(e){var t=new Blob([e]),i=window.URL.createObjectURL(t),o=new Worker(i);"function"==typeof n&&n(o)},function(e,t){"function"==typeof i&&i(e,t)})},this.getContentsOfFileAtURL=function(e,t,n){var i=new XMLHttpRequest;i.open("GET",e,!0),i.onreadystatechange=function(){4==i.readyState&&(200==i.status?"function"==typeof t&&t(i.responseText):"function"==typeof n&&n(i.status,i.statusText))},i.send()}}function WebSequenceTimer(){var e=this,t=null,n=[];this.init=function(i,o){var a=document.querySelector('script[src$="worker.min.js"]').src;if(a){var l=new WebWorkerFactory;l.makeWorkerUsingScriptAtURL(a,function(o){t=o,t.addEventListener("message",function(t){for(var i=0;i<n.length;i++)"function"==typeof n[i].onSequenceTimerUpdate&&n[i].onSequenceTimerUpdate(e,t.data)}),"function"==typeof i&&i(e)},function(t,n){"function"==typeof o&&o(e,t,n)})}},this.start=function(){t.postMessage({command:"start"})},this.stop=function(){t.postMessage({command:"stop"})},this.updateInterval=function(e){t.postMessage({command:"updateInterval",interval:e})},this.updateIntervalWithTempo=function(t,n){if(t=parseFloat(t),n=parseFloat(n),!isNaN(t)&&t>0){var i=6e4/t;if(!isNaN(n)&&n>0){var o=4*i;i=o*n}e.updateInterval(i)}},this.addSequence=function(e){n.push(e)},this.removeSequence=function(e){for(var t=0;t<n.length;t++)n[t]===e&&n.splice(t,1)}}function WebSequence(){var e=this,t=!1,n=0,i=[];this.repeat=!0,this.play=function(){t=!0},this.pause=function(){t=!1},this.stop=function(){t=!1,n=0},this.reset=function(){t=!1,n=0,i=[]},this.addEvent=function(e){i.push(e)},this.replaceEventAtPosition=function(e,t){t<i.length&&(i[t]=e)},this.removeEventAtPosition=function(e){e<i.length&&i.splice(e,1)},this.triggerEvent=function(e){var t=i[e];"function"==typeof t&&t()},this.advance=function(){n<i.length-1?n++:(n=0,t=1==e.repeat)},this.onSequenceTimerUpdate=function(i,o){t&&(e.triggerEvent(n),e.advance())}}function WebAHDSR(e,t){var n=this;this.context=e,this.param=t,this.attackTime=0,this.holdTime=0,this.decayTime=0,this.releaseTime=0,this.initialValue=0,this.holdValue=1,this.sustainValue=1,this.finalValue=0,this.attackCurve="linear",this.decayCurve="linear",this.releaseCurve="linear",this.on=function(){var e=n.context.currentTime;n.param.cancelScheduledValues(e);var t=Math.max(parseFloat(n.initialValue),n.param.value);"exponential"==n.attackCurve&&0==t&&(t=.001),n.param.linearRampToValueAtTime(t,e),e+=parseFloat(n.attackTime),"exponential"==n.attackCurve?0==n.holdValue?(n.param.exponentialRampToValueAtTime(.001,e),n.param.linearRampToValueAtTime(0,e+.01)):n.param.exponentialRampToValueAtTime(parseFloat(n.holdValue),e):n.param.linearRampToValueAtTime(parseFloat(n.holdValue),e),e+=parseFloat(n.holdTime),n.param.linearRampToValueAtTime(parseFloat(n.holdValue),e),e+=parseFloat(n.decayTime),"exponential"==n.decayCurve?0==n.sustainValue?(n.param.exponentialRampToValueAtTime(.001,e),n.param.linearRampToValueAtTime(0,e+.01)):n.param.exponentialRampToValueAtTime(parseFloat(n.sustainValue),e):n.param.linearRampToValueAtTime(parseFloat(n.sustainValue),e)},this.off=function(){var e=n.context.currentTime;n.param.cancelScheduledValues(e),n.param.linearRampToValueAtTime(n.param.value,e),e+=parseFloat(n.releaseTime),"exponential"==n.releaseCurve?0==n.finalValue?(n.param.exponentialRampToValueAtTime(.001,e),n.param.linearRampToValueAtTime(0,e+.01)):n.param.exponentialRampToValueAtTime(parseFloat(n.finalValue),e):n.param.linearRampToValueAtTime(parseFloat(n.finalValue),e)},this.reset=function(){var e=n.context.currentTime;n.param.cancelScheduledValues(e),n.param.linearRampToValueAtTime(parseFloat(n.initialValue),e)}}function WebNoise(e){var t=this,n=0,i=1;this.context=e,this.node=null,this.blockSize=function(e){return isNaN(parseInt(e))?i:void(i=Math.max(parseInt(e),1))},this.configureNode=function(e){e=e||{};var i=parseInt(e.bufferSize)||256,o=parseInt(e.inputChannels)||1,a=parseInt(e.outputChannels)||1;t.node=t.context.createScriptProcessor(i,o,a),t.node.onaudioprocess=function(e){for(var i=e.outputBuffer,o=t.blockSize(),a=0;a<i.numberOfChannels;a++)for(var l=i.getChannelData(a),r=0;r<i.length;r++)l[r]=r%o==0?n=Math.random():n}}}function WebDrum(e){var t=this;this.context=e,this.tone=this.context.createOscillator(),this.tone.type="square",this.tone.frequency.value=440,this.tone.start(0),this.tonePitchEnv=new WebAHDSR(this.context,this.tone.frequency),this.tonePitchEnv.decayTime=.1,this.tonePitchEnv.releaseTime=.1,this.tonePitchEnv.holdValue=220,this.tonePitchEnv.sustainValue=110,this.toneFilter=this.context.createBiquadFilter(),this.toneFilter.type="lowpass",this.toneFilter.frequency.value=2e4,this.toneFilter.Q.value=1,this.toneFilterEnv=new WebAHDSR(this.context,this.toneFilter.frequency),this.toneFilterEnv.decayTime=.1,this.toneFilterEnv.releaseTime=.1,this.toneFilterEnv.holdValue=1760,this.toneFilterEnv.sustainValue=440,this.toneAmp=this.context.createGain(),this.toneAmp.gain.value=0,this.toneAmpEnv=new WebAHDSR(this.context,this.toneAmp.gain),this.toneAmpEnv.attackTime=.01,this.toneAmpEnv.decayTime=.3,this.toneAmpEnv.releaseTime=.3,this.toneAmpEnv.holdValue=.5,this.toneAmpEnv.sustainValue=0,this.tone.connect(this.toneFilter),this.toneFilter.connect(this.toneAmp),this.noise=new WebNoise(this.context),this.noise.configureNode(),this.noise.blockSize(2),this.noiseFilter=this.context.createBiquadFilter(),this.noiseFilter.type="highpass",this.noiseFilter.frequency.value=2e4,this.noiseFilter.Q.value=1,this.noiseFilterEnv=new WebAHDSR(this.context,this.noiseFilter.frequency),this.noiseFilterEnv.decayTime=.3,this.noiseFilterEnv.releaseTime=.3,this.noiseFilterEnv.initialValue=220,this.noiseFilterEnv.holdValue=220,this.noiseFilterEnv.sustainValue=1760,this.noiseAmp=this.context.createGain(),this.noiseAmp.gain.value=0,this.noiseAmpEnv=new WebAHDSR(this.context,this.noiseAmp.gain),this.noiseAmpEnv.attackTime=.01,this.noiseAmpEnv.decayTime=.3,this.noiseAmpEnv.releaseTime=.3,this.noiseAmpEnv.holdValue=.5,this.noiseAmpEnv.sustainValue=0,this.noise.node.connect(this.noiseFilter),this.noiseFilter.connect(this.noiseAmp),this.mix=this.context.createGain(),this.mix.gain.value=.5,this.toneAmp.connect(this.mix),this.noiseAmp.connect(this.mix),this.trigger=function(){t.tonePitchEnv.on(),t.toneFilterEnv.on(),t.toneAmpEnv.on(),t.noiseFilterEnv.on(),t.noiseAmpEnv.on()},this.connect=function(e){t.disconnect(),t.mix.connect("object"==typeof e&&e?e:t.context.destination)},this.disconnect=function(){t.mix.disconnect()}}function Knob(e,t){var n=this;return this.element=e,this.onUpdate=null,this.draggable=null,this.minAngle=-135,this.maxAngle=135,this.angle=-135,this.minValue=0,this.maxValue=1,this.speed=1,this.limitAngle=function(e){return Math.min(Math.max(e,n.minAngle),n.maxAngle)},this.limitValue=function(e){return Math.min(Math.max(e,n.minValue),n.maxValue)},this.init=function(t){if(n.element){n.draggable=interact(n.element).draggable({inertia:!0,onmove:function(e){var t=e.dy*n.speed;n.angle=n.limitAngle(n.angle-t),n.update()}});var i=parseFloat(e.getAttribute("data-min-angle"));isNaN(i)||(n.minAngle=i);var o=parseFloat(e.getAttribute("data-max-angle"));isNaN(o)||(n.maxAngle=o);var a=parseFloat(e.getAttribute("data-angle"));isNaN(a)||(n.angle=a);var l=parseFloat(e.getAttribute("data-min-value"));isNaN(l)||(n.minValue=l);var r=parseFloat(e.getAttribute("data-max-value"));isNaN(r)||(n.maxValue=r);var s=parseFloat(e.getAttribute("data-value"));isNaN(s)||(n.angle=n.angleFromValue(s));var u=parseFloat(e.getAttribute("data-speed"));isNaN(u)||(n.speed=u)}if(t&&"object"==typeof t){var i=parseFloat(t.minAngle);isNaN(i)||(n.minAngle=i);var o=parseFloat(t.maxAngle);isNaN(o)||(n.maxAngle=o);var a=parseFloat(t.angle);isNaN(a)||(n.angle=a);var l=parseFloat(t.minValue);isNaN(l)||(n.minValue=l);var r=parseFloat(t.maxValue);isNaN(r)||(n.maxValue=r);var s=parseFloat(t.value);isNaN(s)||(n.value=n.angleFromValue(s));var u=parseFloat(t.speed);isNaN(u)||(n.speed=u),"function"==typeof t.onUpdate&&(n.onUpdate=t.onUpdate)}return n},this.update=function(){return n.element&&(n.updateRotation(),"function"==typeof n.onUpdate&&n.onUpdate(n.currentValue())),n},this.updateRotation=function(){if(n.element){var e=n.limitAngle(n.angle),t="rotate("+e+"deg)";n.element.style.webkitTransform=t,n.element.style.transform=t}},this.currentValue=function(){var e=n.limitAngle(n.angle),t=n.maxAngle-n.minAngle,i=1/(t/(e-n.minAngle)),o=n.maxValue-n.minValue,a=o*i+n.minValue;return a},this.angleFromValue=function(e){e=n.limitValue(e);var t=n.maxValue-n.minValue,i=1/(t/(e-n.minValue)),o=n.maxAngle-n.minAngle,a=o*i+n.minAngle;return a},this.init(t)}function SegmentedSwitch(e,t){var n=this;return this.element=e,this.onUpdate=null,this.poles=function(){var e=[];if(n.element){var t=n.element.querySelectorAll(".pole");e=Array.prototype.slice.call(t)}return e},this.limitIndex=function(e){return Math.min(Math.max(e,0),n.poles().length-1)},this.selectedIndex=function(){for(var e=-1,t=n.poles(),i=0;i<t.length;i++)if(t[i].classList.contains("selected")){e=i;break}return e},this.selectedValue=function(){for(var e=null,t=n.poles(),i=0;i<t.length;i++)if(t[i].classList.contains("selected")){e=t[i].getAttribute("data-value");break}return e},this.init=function(e){for(var t=n.poles(),i=0;i<t.length;i++)t[i].addEventListener("click",function(){n.selectPole(this),n.update()});return e&&"object"==typeof e&&"function"==typeof e.onUpdate&&(n.onUpdate=e.onUpdate),n},this.selectPole=function(e){for(var t=n.poles(),i=0;i<t.length;i++)t[i]===e?t[i].classList.add("selected"):t[i].classList.remove("selected");return n},this.update=function(){return"function"==typeof n.onUpdate&&n.onUpdate(n.selectedIndex(),n.selectedValue()),n},this.init(t)}function ToggleSwitch(e,t){var n=this;return this.element=e,this.onUpdate=null,this.isOn=function(){var e=!1;return n.element&&(e=n.element.classList.contains("on")),e},this.init=function(e){return n.element&&n.element.addEventListener("click",function(){n.isOn()?n.element.classList.remove("on"):n.element.classList.add("on"),n.update()}),e&&"object"==typeof e&&"function"==typeof e.onUpdate&&(n.onUpdate=e.onUpdate),n},this.update=function(){return n.element&&"function"==typeof n.onUpdate&&n.onUpdate(n.isOn()),n},this.init(t)}function WebDrumVoiceController(e,t){var n=this;return this.element=e,this.context=t,this.muted=!1,this.drum=null,this.sequence=null,this.sequenceSwitches=[],this.toneOscTypeSwitch=null,this.tonePitchHoldKnob=null,this.tonePitchSustainKnob=null,this.tonePitchDecayKnob=null,this.tonePitchCurveSwitch=null,this.toneFilterTypeSwitch=null,this.toneFilterQKnob=null,this.toneFilterHoldKnob=null,this.toneFilterSustainKnob=null,this.toneFilterDecayKnob=null,this.toneFilterCurveSwitch=null,this.toneAmpLevelKnob=null,this.toneAmpDecayKnob=null,this.toneAmpCurveSwitch=null,this.noiseFilterTypeSwitch=null,this.noiseFilterQKnob=null,this.noiseFilterHoldKnob=null,this.noiseFilterSustainKnob=null,this.noiseFilterDecayKnob=null,this.noiseFilterCurveSwitch=null,this.noiseAmpLevelKnob=null,this.noiseAmpDecayKnob=null,this.noiseAmpCurveSwitch=null,this.mixGainKnob=null,this.mixMuteSwitch=null,this.toggleSwitch=null,this.init=function(){n.drum=new WebDrum(n.context),n.drum.toneAmpEnv.sustainValue=0,n.drum.noiseAmpEnv.sustainValue=0,n.drum.connect(),n.sequence=new WebSequence,n.toneOscTypeSwitch=new SegmentedSwitch(n.element.querySelector("#tone-osc-type"),{onUpdate:function(e,t){n.drum.tone.type=t}}).update(),n.tonePitchHoldKnob=new Knob(n.element.querySelector("#tone-pitch-hold"),{onUpdate:function(e){n.drum.tonePitchEnv.holdValue=e}}).update(),n.tonePitchSustainKnob=new Knob(n.element.querySelector("#tone-pitch-sustain"),{onUpdate:function(e){n.drum.tonePitchEnv.sustainValue=e}}).update(),n.tonePitchDecayKnob=new Knob(n.element.querySelector("#tone-pitch-decay"),{onUpdate:function(e){n.drum.tonePitchEnv.decayTime=e,n.drum.tonePitchEnv.releaseTime=e}}).update(),n.tonePitchCurveSwitch=new SegmentedSwitch(n.element.querySelector("#tone-pitch-curve"),{onUpdate:function(e,t){n.drum.tonePitchEnv.decayCurve=t,n.drum.tonePitchEnv.releaseCurve=t}}).update(),n.toneFilterTypeSwitch=new SegmentedSwitch(n.element.querySelector("#tone-filter-type"),{onUpdate:function(e,t){n.drum.toneFilter.type=t}}).update(),n.toneFilterQKnob=new Knob(n.element.querySelector("#tone-filter-q"),{onUpdate:function(e){n.drum.toneFilter.Q.value=e}}).update(),n.toneFilterHoldKnob=new Knob(n.element.querySelector("#tone-filter-hold"),{onUpdate:function(e){n.drum.toneFilterEnv.holdValue=e}}).update(),n.toneFilterSustainKnob=new Knob(n.element.querySelector("#tone-filter-sustain"),{onUpdate:function(e){n.drum.toneFilterEnv.sustainValue=e}}).update(),n.toneFilterDecayKnob=new Knob(n.element.querySelector("#tone-filter-decay"),{onUpdate:function(e){n.drum.toneFilterEnv.decayTime=e,n.drum.toneFilterEnv.releaseTime=e}}).update(),n.toneFilterCurveSwitch=new SegmentedSwitch(n.element.querySelector("#tone-filter-curve"),{onUpdate:function(e,t){n.drum.toneFilterEnv.decayCurve=t,n.drum.toneFilterEnv.releaseCurve=t}}).update(),n.toneAmpLevelKnob=new Knob(n.element.querySelector("#tone-amp-level"),{onUpdate:function(e){n.drum.toneAmpEnv.holdValue=e,n.drum.toneAmpEnv.sustainValue=0}}).update(),n.toneAmpDecayKnob=new Knob(n.element.querySelector("#tone-amp-decay"),{onUpdate:function(e){n.drum.toneAmpEnv.decayTime=e,n.drum.toneAmpEnv.releaseTime=e}}).update(),n.toneAmpCurveSwitch=new SegmentedSwitch(n.element.querySelector("#tone-amp-curve"),{onUpdate:function(e,t){n.drum.toneAmpEnv.decayCurve=t,n.drum.toneAmpEnv.releaseCurve=t}}).update(),n.noiseColorKnob=new Knob(n.element.querySelector("#noise-color"),{onUpdate:function(e){var t=Math.pow(2,Math.ceil(e));n.drum.noise.blockSize(t)}}).update(),n.noiseFilterTypeSwitch=new SegmentedSwitch(n.element.querySelector("#noise-filter-type"),{onUpdate:function(e,t){n.drum.noiseFilter.type=t}}).update(),n.noiseFilterQKnob=new Knob(n.element.querySelector("#noise-filter-q"),{onUpdate:function(e){n.drum.noiseFilter.Q.value=e}}).update(),n.noiseFilterHoldKnob=new Knob(n.element.querySelector("#noise-filter-hold"),{onUpdate:function(e){n.drum.noiseFilterEnv.holdValue=e}}).update(),n.noiseFilterSustainKnob=new Knob(n.element.querySelector("#noise-filter-sustain"),{onUpdate:function(e){n.drum.noiseFilterEnv.sustainValue=e}}).update(),n.noiseFilterDecayKnob=new Knob(n.element.querySelector("#noise-filter-decay"),{onUpdate:function(e){n.drum.noiseFilterEnv.decayTime=e,n.drum.noiseFilterEnv.releaseTime=e}}).update(),n.noiseFilterCurveSwitch=new SegmentedSwitch(n.element.querySelector("#noise-filter-curve"),{onUpdate:function(e,t){n.drum.noiseFilterEnv.decayCurve=t,n.drum.noiseFilterEnv.releaseCurve=t}}).update(),n.noiseAmpLevelKnob=new Knob(n.element.querySelector("#noise-amp-level"),{onUpdate:function(e){n.drum.noiseAmpEnv.holdValue=e,n.drum.noiseAmpEnv.sustainValue=0}}).update(),n.noiseAmpDecayKnob=new Knob(n.element.querySelector("#noise-amp-decay"),{onUpdate:function(e){n.drum.noiseAmpEnv.decayTime=e,n.drum.noiseAmpEnv.releaseTime=e}}).update(),n.noiseAmpCurveSwitch=new SegmentedSwitch(n.element.querySelector("#noise-amp-curve"),{onUpdate:function(e,t){n.drum.noiseAmpEnv.decayCurve=t,n.drum.noiseAmpEnv.releaseCurve=t}}).update(),n.mixGainKnob=new Knob(n.element.querySelector("#mix-gain"),{onUpdate:function(e){n.drum.mix.gain.value=e}}).update(),n.mixMuteSwitch=new ToggleSwitch(n.element.querySelector("#mix-mute"),{onUpdate:function(e){n.muted=e}}).update(),n.sequenceSwitches=[];for(var e=n.element.querySelectorAll(".sequence-toggle-switch").length,t=0;e>t;t++)n.sequenceSwitches.push(new ToggleSwitch(n.element.querySelector('.sequence-toggle-switch[data-sequence-step="'+t+'"]')));return n.resetSequence(e)},this.playSequence=function(){n.sequence.play()},this.pauseSequence=function(){n.sequence.pause()},this.stopSequence=function(){n.sequence.stop()},this.resetSequence=function(e){n.sequence.reset();for(var t=0;e>t;t++)n.sequence.addEvent(function(e){return function(){n.sequenceSwitches[e].isOn()&&!n.muted&&n.drum.trigger(),n.highlightStepAtIndex(e)}}(t));return n},this.clearStepHighlights=function(){for(var e=n.element.querySelectorAll(".sequence-toggle-switch.highlighted"),t=0;t<e.length;t++)e[t].classList.remove("highlighted")},this.highlightStepAtIndex=function(e){n.clearStepHighlights(),n.sequenceSwitches[e].element.classList.add("highlighted")},this.init()}function WebDrumMachine(e,t){var n=this;return this.element=e,this.context=t,this.sequenceTimer=null,this.voiceControllers=[],this.playing=!1,this.init=function(){var e={numSequenceSteps:32};n.sequenceTimer=new WebSequenceTimer,n.voiceControllers=[];for(var t=n.element.querySelectorAll(".voice-controller"),i=0;i<t.length;i++){var o=new WebDrumVoiceController(t[i],n.context,e);n.voiceControllers.push(o),n.sequenceTimer.addSequence(o.sequence)}return n.sequenceTimer.init(function(e){n.updateTempo()},function(e,t,n){console.log(n)}),n.element.querySelector("#play-button").addEventListener("click",function(){n.playing?n.pause():n.play(),n.playing=!n.playing,n.refreshTransportControls()}),n.element.querySelector("#stop-button").addEventListener("click",function(){n.stop(),n.playing=!1,n.refreshTransportControls()}),n.element.querySelector("#tempo-input").addEventListener("change",function(){n.updateTempo()}),n.element.querySelector("#tempo-form").addEventListener("submit",function(e){e.preventDefault()}),n},this.play=function(){n.sequenceTimer.start();for(var e=0;e<n.voiceControllers.length;e++)n.voiceControllers[e].playSequence();return n},this.pause=function(){n.sequenceTimer.stop();for(var e=0;e<n.voiceControllers.length;e++)n.voiceControllers[e].pauseSequence()},this.stop=function(){n.sequenceTimer.stop();for(var e=0;e<n.voiceControllers.length;e++)n.voiceControllers[e].stopSequence(),n.voiceControllers[e].clearStepHighlights();return n},this.refreshTransportControls=function(){var e=n.element.querySelector("#play-button"),t=n.element.querySelector("#play-button > i");n.playing?(e.classList.add("on"),t.classList.remove("fa-play"),t.classList.add("fa-pause")):(e.classList.remove("on"),t.classList.remove("fa-pause"),t.classList.add("fa-play"))},this.updateTempo=function(){var e=parseFloat(n.element.querySelector("#tempo-input").value);isNaN(e)||n.sequenceTimer.updateIntervalWithTempo(e,1/16)},this.init()}window.addEventListener("load",function(){var e=null;return"undefined"!=typeof window.AudioContext?e=new AudioContext:"undefined"!=typeof window.webkitAudioContext&&(e=new webkitAudioContext),e?void(window.drumMachine=new WebDrumMachine(document.querySelector("#drum-machine"),e)):void console.log("Web Audio API is not supported.")});